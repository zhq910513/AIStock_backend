[root@instance-p3lfwf3w data]# ls
backend  compose  frontend  nginx  runtime
[root@instance-p3lfwf3w data]# cd backend/aistock_backend/
[root@instance-p3lfwf3w aistock_backend]# ls
app  cmd.txt  docker-compose.yml  Dockerfile  main.py  original_requirement.MD  README.md  requirements.txt  tree.txt
[root@instance-p3lfwf3w aistock_backend]# cd ..
[root@instance-p3lfwf3w backend]# cd ..
[root@instance-p3lfwf3w data]# cd frontend/aistock_frontend/
[root@instance-p3lfwf3w aistock_frontend]# ls
ERROR  index.html
[root@instance-p3lfwf3w aistock_frontend]# cd ..
[root@instance-p3lfwf3w frontend]# cd ..
[root@instance-p3lfwf3w data]# cd nginx/conf.d/
[root@instance-p3lfwf3w conf.d]# ls
default.conf
[root@instance-p3lfwf3w conf.d]# cat default.conf 
server {
    listen 80 default_server;
    server_name _;

    gzip on;
    gzip_min_length 1k;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss;

    client_max_body_size 50m;
    server_tokens off;

    # ----------------------------
    # Dingchang 前端（根站点）
    # ----------------------------
    root /usr/share/nginx/html;
    index index.html;

    location ^~ /assets/ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        try_files $uri =404;
    }

    location = /favicon.ico {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        try_files $uri =404;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Dingchang API：/api/* -> dingchang_backend:8000
    location ^~ /api/ {
        proxy_pass http://dingchang_backend:8000;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering off;
    }

    location = /health {
        proxy_pass http://dingchang_backend:8000/api/health;
    }

    # ----------------------------
    # AIStock 前端：/aistock/
    # ----------------------------
    location ^~ /aistock/assets/ {
        alias /usr/share/nginx/html_aistock/assets/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        try_files $uri =404;
    }

    location ^~ /aistock/ {
        alias /usr/share/nginx/html_aistock/;
        try_files $uri $uri/ /aistock/index.html;
    }

    # ----------------------------
    # AIStock API：/aistock/api/* -> backend:8000 (保持前缀，不 rewrite)
    # ----------------------------
    location ^~ /aistock/api/ {
        # 用 compose service 名 backend，更稳（不依赖 container_name 解析）
        proxy_pass http://backend:8000;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 让后端/框架知道它挂载在这个前缀下（配合 FastAPI root_path）
        proxy_set_header X-Forwarded-Prefix /aistock/api;

        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_buffering off;
    }

    # /aistock/health -> 后端 /health
    location = /aistock/health {
        rewrite ^ /health break;

        proxy_pass http://backend:8000;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        proxy_buffering off;
    }
}

[root@instance-p3lfwf3w conf.d]# cd ..
[root@instance-p3lfwf3w nginx]# cd ..
[root@instance-p3lfwf3w data]# cd compose/aistock/
[root@instance-p3lfwf3w aistock]# ls
backend.env  docker-compose.yml
[root@instance-p3lfwf3w aistock]# cat backend.env 
# ---------- basic ----------
ENV=prod
TZ=Asia/Shanghai

# ---------- database ----------
# docker-compose 网络内：host 用 db
# 建议用 sqlite://// 前缀，避免 sqlite+pysqlite 判断分支遗漏导致线程参数未配置
DATABASE_URL=sqlite:////app/db/aistock.sqlite3

# ---------- api reverse-proxy ----------
# Nginx 前缀：/aistock/api
API_ROOT_PATH=/aistock/api

# ---------- labeling research factory (待打标数据工厂) ----------
# 开启后：上传待打标候选 -> 自动入 watchlist -> 自动规划并触发 iFinD 拉数 -> 持续刷新 & 维度扩展 -> 产出 feature snapshots
LABELING_AUTO_FETCH_ENABLED=true

# 可选调参（注意：这里之前每行前面有空格，会导致 env_file 解析不稳定；已全部去掉）
LABELING_PIPELINE_POLL_MS=1000
LABELING_REFRESH_BASE_SEC=21600
LABELING_REFRESH_ACTIVE_SEC=1800
LABELING_HISTORY_DAYS_BASE=60
LABELING_HISTORY_DAYS_EXPAND=180
LABELING_HISTORY_DAYS_MAX=360
LABELING_HF_LIMIT_BASE=240
LABELING_MAX_SYMBOLS_PER_CYCLE=50

# ---------- orchestrator ----------
ORCH_SYMBOLS=000001.SZ,600000.SH
ORCH_LOOP_INTERVAL_MS=500
SCHED_DRIFT_THRESHOLD_MS=250

# ---------- anti-leakage ----------
EPSILON_MIN_MS=200

# ---------- frozen versions ----------
# 这里之前是 canon_v1=（末尾多一个等号），会造成版本键异常；已修正
CANONICALIZATION_VERSION=canon_v1
RULESET_VERSION_HASH=ruleset_dev_hash_001
STRATEGY_CONTRACT_HASH=contract_dev_hash_001
MODEL_SNAPSHOT_UUID=stable_model_001
COST_MODEL_VERSION=cost_v1
FEATURE_EXTRACTOR_VERSION=fx_v1

# ---------- THS adapter ----------
# MOCK / IFIND_HTTP / IFIND_SDK / DATAFEED
THS_MODE=IFIND_HTTP
IFIND_HTTP_BASE_URL=https://quantapi.51ifind.com
IFIND_HTTP_TOKEN=11de3f829bb07dee3275c5a3936c8c4d2f909aec.signs_ODMxNDYzOTE1
IFIND_HTTP_REFRESH_TOKEN=eyJzaWduX3RpbWUiOiIyMDI2LTAxLTE0IDAwOjQ0OjMwIn0=.eyJ1aWQiOiI4MzE0NjM5MTUiLCJ1c2VyIjp7ImFjY2Vzc1Rva2VuIjoiODA5MmQ4ODI5M2MxMTljYjk3MzZmNTkyNmVjM2EzYzY5MDg4Yzk5NC5zaWduc19PRE14TkRZek9URTEiLCJhY2Nlc3NUb2tlbkV4cGlyZWRUaW1lIjoiMjAyNi0wMS0xNCAwMDo0NDozMCIsImFjY291bnQiOiJianptaGowMDEiLCJhdXRoVXNlckluZm8iOnsiYXBpRm9ybWFsIjoiMSJ9LCJjb2RlQ1NJIjpbXSwiY29kZVp6QXV0aCI6W10sImhhc0FJUHJlZGljdCI6ZmFsc2UsImhhc0FJVGFsayI6ZmFsc2UsImhhc0NJQ0MiOmZhbHNlLCJoYXNDU0kiOmZhbHNlLCJoYXNFdmVudERyaXZlIjpmYWxzZSwiaGFzRlRTRSI6ZmFsc2UsImhhc0Zhc3QiOmZhbHNlLCJoYXNGdW5kVmFsdWF0aW9uIjpmYWxzZSwiaGFzSEsiOmZhbHNlLCJoYXNMTUUiOmZhbHNlLCJoYXNMZXZlbDIiOmZhbHNlLCJoYXNSZWFsQ01FIjpmYWxzZSwiaGFzVHJhbnNmZXIiOmZhbHNlLCJoYXNVUyI6ZmFsc2UsImhhc1VTQUluZGV4IjpmYWxzZSwiaGFzVVNERUJUIjpmYWxzZSwibWFya2V0QXV0aCI6eyJEQ0UiOmZhbHNlfSwibWF4T25MaW5lIjoxLCJub0Rpc2siOmZhbHNlLCJwcm9kdWN0VHlwZSI6IlNVUEVSQ09NTUFORFBST0RVQ1QiLCJyZWZyZXNoVG9rZW5FeHBpcmVkVGltZSI6IjIwMjYtMDItMDQgMTY6MDM6MjAiLCJzZXNzc2lvbiI6ImE3ZmNjZDFhMjE0NzljMDc5NjczZWNmMWY4YWJmNWM5Iiwic2lkSW5mbyI6ezU6IjEiLDY6IjEiLDU0OiIwMDAwMDAwMDAwMTEwMDAwMDEwMTAwMDAwMTAwMTAwMDAwMCIsNzoiMTExMTExMTExMTEiLDg5OiIwMDAwMDAwMDAwMDAwMTExMTExMDAwMDAiLDkwOiIwMDAwMDAwMDAwMDAwMDAwMDExMTAwMDAwMCIsNDQ6IjExIiw2MjoiMDAwMDAwMDAwMDAwMDAwMDAwMDEwMDAwIn0sInRpbWVzdGFtcCI6IjE3NjgzMjI2NzA3MTMiLCJ0cmFuc0F1dGgiOmZhbHNlLCJ0dGxWYWx1ZSI6MCwidWlkIjoiODMxNDYzOTE1IiwidXNlclR5cGUiOiJPRkZJQ0lBTCIsIndpZmluZExpbWl0TWFwIjp7fX19.0FC3A24109DDB924D33403B1ED7D1E89972DD69CFAE8D210E97C465DCA18761D

# ---------- S³.1 Differential Audit ----------
SHADOW_LIVE_ENABLED=false
OLD_STRATEGY_CONTRACT_HASH=contract_old_hash
NEW_STRATEGY_CONTRACT_HASH=contract_new_hash
CONTRA_POSITION_DELTA_THRESHOLD=0.30
CONTRA_GUARD_LEVEL_DELTA_THRESHOLD=1

# ---------- S³.1 Cross-Source Reconciliation ----------
POST_MARKET_RECONCILE_ENABLED=true
SOURCE_FIDELITY_K=2.0
SOURCE_FIDELITY_DEGRADE_DELTA=0.10
SOURCE_FIDELITY_LOW_SCORE=0.80
SOURCE_FIDELITY_LOW_STREAK_N=3

# ---------- governance: trade gate ----------
REQUIRE_SELF_CHECK_FOR_TRADING=true
SELF_CHECK_MAX_AGE_SEC=3600

# ---------- governance: reset flow ----------
RESET_REQUIRE_DEVOPS_SIGNATURE=true

# 数据源（你这里已经是 IFIND_HTTP，与 THS_MODE 一致）
DATA_PROVIDER=IFIND_HTTP

[root@instance-p3lfwf3w aistock]# cat docker-compose.yml 
services:
  backend:
    build:
      context: /data/backend/aistock_backend
      dockerfile: Dockerfile
    container_name: aistock_backend
    restart: always

    env_file:
      - ./backend.env

    environment:
      - TZ=Asia/Shanghai

    volumes:
      - /data/runtime/aistock/storage:/app/storage
      - /data/runtime/aistock/logs:/app/logs
      - /data/runtime/aistock/db:/app/db

    expose:
      - "8000"

    networks:
      - gateway

networks:
  gateway:
    external: true
